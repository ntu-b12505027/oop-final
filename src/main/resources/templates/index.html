<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>å®¿èˆæ´—è¡£æ©Ÿç®¡ç†ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .machine-card {
            transition: transform 0.2s;
            height: 100%;
        }
        .machine-card:hover {
            transform: translateY(-2px);
        }
        .washing-icon::before {
            content: "ã€œ";
            font-size: 1.8em;
            margin-right: 8px;
            color: #0066cc;
            font-weight: bold;
        }
        .drying-icon::before {
            content: "â—‹";
            font-size: 1.8em;
            margin-right: 8px;
            color: #ff6600;
            font-weight: bold;
        }
        .available-bg {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border-left: 4px solid #28a745;
        }
        .in-use-bg {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border-left: 4px solid #ffc107;
        }
        .out-of-order-bg {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border-left: 4px solid #dc3545;
        }
        .reservation-form {
            margin-top: 15px;
            padding: 15px;
            background-color: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }
        .floor-header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .system-title {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: bold;
        }
        
        /* å€’æ•¸è¨ˆæ™‚æ¨£å¼ */
        .countdown-timer {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 16px;
            padding: 8px 12px;
            border-radius: 20px;
            display: inline-block;
            min-width: 120px;
            text-align: center;
            background: linear-gradient(135deg, #ffc107 0%, #ffcd39 100%);
            color: #212529;
            border: 2px solid #ffc107;
            box-shadow: 0 2px 4px rgba(255, 193, 7, 0.3);
        }
        
        .countdown-timer.warning {
            background: linear-gradient(135deg, #fd7e14 0%, #ff8c42 100%);
            border-color: #fd7e14;
            animation: pulse 1s infinite;
            box-shadow: 0 2px 8px rgba(253, 126, 20, 0.4);
        }
        
        .countdown-timer.danger {
            background: linear-gradient(135deg, #dc3545 0%, #e55353 100%);
            border-color: #dc3545;
            color: white;
            animation: blink 0.8s infinite;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.5);
        }
        
        .countdown-timer.completed {
            background: linear-gradient(135deg, #28a745 0%, #34ce57 100%);
            border-color: #28a745;
            color: white;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.4);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
        
        .time-display {
            font-weight: bold;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            max-width: 400px;
            animation: slideInRight 0.5s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .time-info {
            background: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <!-- æ¨™é¡Œ -->
                <h1 class="text-center my-4 system-title">ğŸ  å®¿èˆæ´—è¡£æ©Ÿç®¡ç†ç³»çµ±</h1>
                
                <!-- æˆåŠŸè¨Šæ¯ -->
                <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    <span th:text="${success}">æˆåŠŸè¨Šæ¯</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                
                <!-- éŒ¯èª¤è¨Šæ¯ -->
                <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <span th:text="${error}">éŒ¯èª¤è¨Šæ¯</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                
                <!-- æ¨“å±¤é¸æ“‡ -->
                <div class="text-center mb-4">
                    <div class="btn-group" role="group">
                        <a th:href="@{/(floor=1)}" 
                           th:class="${currentFloor == 1} ? 'btn btn-primary btn-lg' : 'btn btn-outline-primary btn-lg'">
                           1æ¨“
                        </a>
                        <a th:href="@{/(floor=2)}" 
                           th:class="${currentFloor == 2} ? 'btn btn-primary btn-lg' : 'btn btn-outline-primary btn-lg'">
                           2æ¨“
                        </a>
                        <a th:href="@{/(floor=3)}" 
                           th:class="${currentFloor == 3} ? 'btn btn-primary btn-lg' : 'btn btn-outline-primary btn-lg'">
                           3æ¨“
                        </a>
                        <a th:href="@{/(floor=4)}" 
                           th:class="${currentFloor == 4} ? 'btn btn-primary btn-lg' : 'btn btn-outline-primary btn-lg'">
                           4æ¨“
                        </a>
                    </div>
                </div>
                
                <!-- æ¨“å±¤æ¨™é¡Œ -->
                <div class="floor-header text-center">
                    <h2 class="mb-0">
                        <i class="fas fa-building me-2"></i>
                        ç¬¬ <span th:text="${currentFloor}">1</span> æ¨“æ©Ÿå°ç‹€æ³
                        <small class="ms-3">â±ï¸ å³æ™‚å€’æ•¸è¨ˆæ™‚</small>
                    </h2>
                </div>
            </div>
        </div>
        
        <!-- æ©Ÿå°åˆ—è¡¨ -->
        <div class="row g-4">
            <!-- ç•¶æœ‰æ©Ÿå°è³‡æ–™æ™‚ -->
            <div th:if="${machines != null and !machines.isEmpty()}">
                <div class="row g-4">
                    <div th:each="machine : ${machines}" class="col-xl-4 col-lg-6 col-md-6 col-sm-12">
                        <div class="card machine-card shadow-sm h-100"
                             th:classappend="${machine.status.name() == 'AVAILABLE'} ? 'available-bg' : 
                                            (${machine.status.name() == 'IN_USE'} ? 'in-use-bg' : 'out-of-order-bg')">
                            <div class="card-body d-flex flex-column">
                                <!-- æ©Ÿå°æ¨™é¡Œ -->
                                <h5 class="card-title fw-bold mb-3">
                                    <span th:classappend="${machine.type.name() == 'WASHING'} ? 'washing-icon' : 'drying-icon'"></span>
                                    <span th:text="${machine.name}">æ©Ÿå°åç¨±</span>
                                </h5>
                                
                                <!-- æ©Ÿå°è³‡è¨Š -->
                                <div class="mb-3">
                                    <p class="card-text mb-2">
                                        <strong>ğŸ”§ é¡å‹ï¼š</strong>
                                        <span th:if="${machine.type.name() == 'WASHING'}" class="badge bg-info">æ´—è¡£æ©Ÿ</span>
                                        <span th:if="${machine.type.name() == 'DRYING'}" class="badge bg-warning">çƒ˜è¡£æ©Ÿ</span>
                                    </p>
                                    
                                    <p class="card-text mb-3">
                                        <strong>ğŸ“Š ç‹€æ…‹ï¼š</strong>
                                        <span th:if="${machine.status.name() == 'AVAILABLE'}" class="badge bg-success fs-6">âœ… å¯ç”¨</span>
                                        <span th:if="${machine.status.name() == 'IN_USE'}" class="badge bg-warning fs-6">â° ä½¿ç”¨ä¸­</span>
                                        <span th:if="${machine.status.name() == 'OUT_OF_ORDER'}" class="badge bg-danger fs-6">âŒ æ•…éšœ</span>
                                    </p>
                                </div>
                                
                                <!-- ä½¿ç”¨ä¸­æ©Ÿå°çš„å³æ™‚å€’æ•¸è¨ˆæ™‚ -->
                                <div th:if="${machine.status.name() == 'IN_USE'}" class="mb-3">
                                    <div class="time-info">
                                        <p class="mb-2">
                                            <strong>ğŸ  ä½¿ç”¨æˆ¿è™Ÿï¼š</strong>
                                            <span class="text-primary fw-bold" th:text="${machine.currentUserRoom}">-</span>
                                        </p>
                                        <p class="mb-2">
                                            <strong>â±ï¸ å‰©é¤˜æ™‚é–“ï¼š</strong>
                                        </p>
                                        <!-- å³æ™‚å€’æ•¸è¨ˆæ™‚å™¨ -->
                                        <div class="text-center">
                                            <span th:if="${machine.remainingMinutes != null and machine.remainingMinutes > 0}" 
                                                  th:data-machine-id="${machine.machineId}"
                                                  th:data-remaining="${machine.remainingMinutes}"
                                                  th:data-user="${machine.currentUserRoom}"
                                                  class="countdown-timer">
                                                <i class="fas fa-clock me-2"></i>
                                                <span class="time-display" th:text="${machine.remainingMinutes} + 'åˆ†é˜'"></span>
                                            </span>
                                            <span th:unless="${machine.remainingMinutes != null and machine.remainingMinutes > 0}" 
                                                  class="badge bg-secondary">æ™‚é–“æœªè¨­å®š</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- æŒ‰éˆ•å€åŸŸ -->
                                <div class="mt-auto">
                                    <!-- å¯ç”¨æ©Ÿå°ï¼šé ç´„æŒ‰éˆ• -->
                                    <div th:if="${machine.status.name() == 'AVAILABLE'}">
                                        <button class="btn btn-success btn-lg w-100 fw-bold" 
                                                th:onclick="|toggleForm('form-${machine.machineId}')|">
                                            ğŸ“… ç«‹å³é ç´„
                                        </button>
                                        
                                        <!-- é ç´„è¡¨å–® -->
                                        <div th:id="|form-${machine.machineId}|" class="reservation-form">
                                            <h6 class="text-center mb-3 text-primary fw-bold">ğŸ“ å¡«å¯«é ç´„è³‡è¨Š</h6>
                                            <form th:action="@{/reservation/make}" method="post">
                                                <input type="hidden" name="machineId" th:value="${machine.machineId}">
                                                <input type="hidden" name="floor" th:value="${currentFloor}">
                                                
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">ğŸ“ å­¸è™Ÿï¼š</label>
                                                    <input type="text" name="studentId" class="form-control" 
                                                           placeholder="ä¾‹å¦‚ï¼šB12345678" required maxlength="15">
                                                    <div class="form-text">è«‹è¼¸å…¥æ‚¨çš„å­¸è™Ÿ</div>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">ğŸ  æˆ¿è™Ÿï¼š</label>
                                                    <input type="text" name="userRoom" class="form-control" 
                                                           placeholder="ä¾‹å¦‚ï¼š101ã€205" required maxlength="10">
                                                    <div class="form-text">è«‹è¼¸å…¥æ‚¨çš„æˆ¿é–“è™Ÿç¢¼</div>
                                                </div>
                                                
                                                <div class="d-grid gap-2">
                                                    <button type="submit" class="btn btn-primary fw-bold">
                                                        âœ… ç¢ºèªé ç´„ï¼ˆ1å°æ™‚ï¼‰
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary" 
                                                            th:onclick="|toggleForm('form-${machine.machineId}')|">
                                                        âŒ å–æ¶ˆ
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                    
                                    <!-- ğŸ—‘ï¸ å·²ç§»é™¤ä½¿ç”¨ä¸­æ©Ÿå°çš„å–æ¶ˆé ç´„æŒ‰éˆ• -->
                                    
                                    <!-- æ•…éšœæ©Ÿå° -->
                                    <div th:if="${machine.status.name() == 'OUT_OF_ORDER'}">
                                        <button class="btn btn-secondary btn-lg w-100 fw-bold" disabled>
                                            ğŸ”§ ç¶­ä¿®ä¸­ï¼Œæš«åœæœå‹™
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ²’æœ‰æ©Ÿå°æ™‚é¡¯ç¤º -->
            <div th:if="${machines == null or machines.isEmpty()}" class="col-12">
                <div class="alert alert-info text-center py-5">
                    <h3 class="mb-3">ğŸ˜” ç¬¬ <span th:text="${currentFloor}">1</span> æ¨“ç›®å‰æ²’æœ‰æ©Ÿå°</h3>
                    <p class="mb-0">è«‹é¸æ“‡å…¶ä»–æ¨“å±¤æŸ¥çœ‹æ©Ÿå°ç‹€æ³</p>
                </div>
            </div>
        </div>
        
        <!-- åº•éƒ¨åŠŸèƒ½é€£çµ -->
        <div class="text-center my-5">
            <div class="btn-group" role="group">
                <a href="/admin" class="btn btn-outline-primary btn-lg">
                    ğŸ”§ ç®¡ç†å“¡é¢æ¿
                </a>
                <a href="/reservation/my" class="btn btn-outline-info btn-lg">
                    ğŸ“‹ æˆ‘çš„é ç´„
                </a>
            </div>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- ä¸»é å€’æ•¸è¨ˆæ™‚åŠŸèƒ½ -->
	<script>
	// ä¸»é å€’æ•¸è¨ˆæ™‚ç®¡ç†å™¨ï¼ˆlocalStorage ç‰ˆæœ¬ï¼‰
	class MainPageCountdown {
	    constructor() {
	        this.timers = new Map();
	        this.completedMachines = new Set();
	        this.init();
	    }
	    
	    init() {
	        console.log('ğŸ  ä¸»é å€’æ•¸è¨ˆæ™‚ç³»çµ±å•Ÿå‹•...');
	        
	        // æ¸…ç†éæœŸçš„ localStorage è³‡æ–™
	        this.cleanExpiredStorage();
	        
	        document.querySelectorAll('.countdown-timer').forEach(timer => {
	            const machineId = timer.dataset.machineId;
	            const remainingMinutes = parseInt(timer.dataset.remaining);
	            const userRoom = timer.dataset.user;
	            
	            // ğŸ†• å„ªå…ˆå¾ localStorage æ¢å¾©å€’æ•¸è¨ˆæ™‚
	            const savedEndTime = localStorage.getItem(`machine_${machineId}_endTime`);
	            const savedUserRoom = localStorage.getItem(`machine_${machineId}_userRoom`);
	            
	            if (savedEndTime && savedUserRoom) {
	                const now = Date.now();
	                const remainingSeconds = Math.max(0, Math.floor((parseInt(savedEndTime) - now) / 1000));
	                
	                if (remainingSeconds > 0) {
	                    console.log(`ğŸ”„ å¾ localStorage æ¢å¾©æ©Ÿå™¨ ${machineId} å€’æ•¸è¨ˆæ™‚: ${remainingSeconds} ç§’`);
	                    this.startCountdown(machineId, remainingSeconds, savedUserRoom);
	                    return;
	                } else {
	                    // æ™‚é–“å·²éï¼Œæ¸…é™¤ localStorage
	                    this.clearMachineStorage(machineId);
	                }
	            }
	            
	            // æ²’æœ‰å„²å­˜çš„æ™‚é–“ï¼Œä½¿ç”¨ä¼ºæœå™¨æ™‚é–“
	            if (remainingMinutes > 0 && !this.completedMachines.has(machineId)) {
	                console.log(`â° ä¸»é å•Ÿå‹•æ©Ÿå™¨ ${machineId} å€’æ•¸è¨ˆæ™‚: ${remainingMinutes} åˆ†é˜`);
	                this.startCountdown(machineId, remainingMinutes * 60, userRoom);
	            }
	        });
	        
	        // æ¯2åˆ†é˜èˆ‡ä¼ºæœå™¨åŒæ­¥ä¸€æ¬¡
	        setInterval(() => this.syncWithServer(), 120000);
	        
	        console.log('âœ… ä¸»é å€’æ•¸è¨ˆæ™‚ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
	    }
	    
	    startCountdown(machineId, remainingSeconds, userRoom) {
	        // æª¢æŸ¥æ˜¯å¦å·²å®Œæˆ
	        if (this.completedMachines.has(machineId)) {
	            console.log(`âš ï¸ æ©Ÿå™¨ ${machineId} å·²å®Œæˆï¼Œä¸å•Ÿå‹•æ–°çš„è¨ˆæ™‚å™¨`);
	            return;
	        }
	        
	        // ğŸ†• è¨ˆç®—ä¸¦å„²å­˜çœŸå¯¦çš„çµæŸæ™‚é–“åˆ° localStorage
	        const endTime = Date.now() + (remainingSeconds * 1000);
	        localStorage.setItem(`machine_${machineId}_endTime`, endTime.toString());
	        localStorage.setItem(`machine_${machineId}_userRoom`, userRoom);
	        console.log(`ğŸ’¾ å„²å­˜æ©Ÿå™¨ ${machineId} çµæŸæ™‚é–“åˆ° localStorage: ${new Date(endTime)}`);
	        
	        // æ¸…é™¤èˆŠçš„è¨ˆæ™‚å™¨
	        if (this.timers.has(machineId)) {
	            clearInterval(this.timers.get(machineId));
	            this.timers.delete(machineId);
	        }
	        
	        const timerElement = document.querySelector(`[data-machine-id="${machineId}"] .time-display`);
	        const badgeElement = document.querySelector(`[data-machine-id="${machineId}"]`);
	        
	        if (!timerElement || !badgeElement) {
	            console.error(`âŒ æ‰¾ä¸åˆ°æ©Ÿå™¨ ${machineId} çš„è¨ˆæ™‚å™¨å…ƒç´ `);
	            return;
	        }
	        
	        const timer = setInterval(() => {
	            // å†æ¬¡æª¢æŸ¥æ˜¯å¦å·²å®Œæˆ
	            if (this.completedMachines.has(machineId)) {
	                console.log(`ğŸ›‘ æ©Ÿå™¨ ${machineId} å·²æ¨™è¨˜ç‚ºå®Œæˆï¼Œåœæ­¢è¨ˆæ™‚å™¨`);
	                clearInterval(timer);
	                this.timers.delete(machineId);
	                return;
	            }
	            
	            // ğŸ†• åŸºæ–¼ localStorage ä¸­çš„çµæŸæ™‚é–“è¨ˆç®—çœŸå¯¦å‰©é¤˜æ™‚é–“
	            const savedEndTime = localStorage.getItem(`machine_${machineId}_endTime`);
	            if (!savedEndTime) {
	                console.log(`âš ï¸ æ©Ÿå™¨ ${machineId} çš„ localStorage è³‡æ–™éºå¤±ï¼Œåœæ­¢è¨ˆæ™‚å™¨`);
	                clearInterval(timer);
	                this.timers.delete(machineId);
	                return;
	            }
	            
	            const now = Date.now();
	            const realRemainingSeconds = Math.max(0, Math.floor((parseInt(savedEndTime) - now) / 1000));
	            
	            if (realRemainingSeconds <= 0) {
	                // ç«‹å³æ¨™è¨˜ç‚ºå®Œæˆ
	                this.completedMachines.add(machineId);
	                
	                // åœæ­¢è¨ˆæ™‚å™¨
	                clearInterval(timer);
	                this.timers.delete(machineId);
	                
	                console.log(`ğŸ¯ æ©Ÿå™¨ ${machineId} æ™‚é–“åˆ°ï¼ç«‹å³åœæ­¢è¨ˆæ™‚å™¨`);
	                this.onTimeExpired(machineId, userRoom);
	                return;
	            }
	            
	            // æ›´æ–°é¡¯ç¤º
	            const minutes = Math.floor(realRemainingSeconds / 60);
	            const seconds = realRemainingSeconds % 60;
	            
	            let display;
	            if (minutes > 0) {
	                display = `${minutes}åˆ†${seconds.toString().padStart(2, '0')}ç§’`;
	            } else {
	                display = `${seconds}ç§’`;
	            }
	            
	            timerElement.innerHTML = `<i class="fas fa-clock me-2"></i>${display}`;
	            
	            // æ ¹æ“šå‰©é¤˜æ™‚é–“èª¿æ•´æ¨£å¼
	            this.updateTimerStyle(badgeElement, realRemainingSeconds);
	            
	        }, 1000);
	        
	        this.timers.set(machineId, timer);
	    }
	    
	    onTimeExpired(machineId, userRoom) {
	        console.log(`ğŸ‰ æ©Ÿå™¨ ${machineId} æ™‚é–“åˆ°ï¼æˆ¿é–“ ${userRoom}`);
	        
	        // ç¢ºä¿è¨ˆæ™‚å™¨å·²åœæ­¢ä¸”æ¨™è¨˜ç‚ºå®Œæˆ
	        if (this.timers.has(machineId)) {
	            clearInterval(this.timers.get(machineId));
	            this.timers.delete(machineId);
	        }
	        this.completedMachines.add(machineId);
	        
	        // ğŸ†• æ¸…é™¤ localStorage è³‡æ–™
	        this.clearMachineStorage(machineId);
	        
	        const timerElement = document.querySelector(`[data-machine-id="${machineId}"]`);
	        
	        if (!timerElement) {
	            console.error(`âŒ æ‰¾ä¸åˆ°æ©Ÿå™¨ ${machineId} çš„è¨ˆæ™‚å™¨å…ƒç´ `);
	            return;
	        }
	        
	        // ç«‹å³æ›´æ–°é¡¯ç¤º
	        timerElement.innerHTML = '<i class="fas fa-check me-2"></i>æ´—è¡£å®Œæˆ';
	        timerElement.className = 'countdown-timer completed';
	        
	        // é¡¯ç¤ºé€šçŸ¥
	        this.showNotification(
	            `ğŸ‰ æ´—è¡£å®Œæˆï¼`,
	            `æˆ¿é–“ ${userRoom} çš„æ©Ÿå™¨ #${machineId} å·²å®Œæˆä½¿ç”¨ï¼Œå¯ä»¥å»æ”¶è¡£æœäº†ï¼`,
	            'success',
	            10000
	        );
	        
	        // æ’­æ”¾æç¤ºéŸ³
	        this.playNotificationSound();
	        
	        // é€šçŸ¥ä¼ºæœå™¨ä½†ä¸ä¾è³´çµæœ
	        this.notifyServerAsync(machineId);
	        
	        // å»¶é²é‡æ–°æ•´ç†é é¢
	        setTimeout(() => {
	            console.log('ğŸ”„ æ´—è¡£å®Œæˆï¼Œé‡æ–°æ•´ç†é é¢åŒæ­¥ç‹€æ…‹...');
	            window.location.reload();
	        }, 8000);
	    }
	    
	    // ğŸ†• æ¸…é™¤æ©Ÿå™¨çš„ localStorage è³‡æ–™
	    clearMachineStorage(machineId) {
	        localStorage.removeItem(`machine_${machineId}_endTime`);
	        localStorage.removeItem(`machine_${machineId}_userRoom`);
	        console.log(`ğŸ—‘ï¸ æ¸…é™¤æ©Ÿå™¨ ${machineId} çš„ localStorage è³‡æ–™`);
	    }
	    
	    // ğŸ†• æ¸…ç†éæœŸçš„ localStorage è³‡æ–™
	    cleanExpiredStorage() {
	        const now = Date.now();
	        const keysToRemove = [];
	        
	        for (let i = 0; i < localStorage.length; i++) {
	            const key = localStorage.key(i);
	            if (key && key.startsWith('machine_') && key.endsWith('_endTime')) {
	                const endTime = parseInt(localStorage.getItem(key));
	                if (endTime && endTime < now) {
	                    // æ‰¾åˆ°å°æ‡‰çš„æ©Ÿå™¨ID
	                    const machineId = key.replace('machine_', '').replace('_endTime', '');
	                    keysToRemove.push(machineId);
	                }
	            }
	        }
	        
	        // æ¸…é™¤éæœŸçš„è³‡æ–™
	        keysToRemove.forEach(machineId => {
	            this.clearMachineStorage(machineId);
	            console.log(`ğŸ§¹ æ¸…é™¤éæœŸçš„æ©Ÿå™¨ ${machineId} localStorage è³‡æ–™`);
	        });
	    }
	    
	    // å…¶ä»–æ–¹æ³•ä¿æŒä¸è®Š...
	    updateTimerStyle(badgeElement, remainingSeconds) {
	        badgeElement.className = badgeElement.className.replace(/warning|danger|completed/g, '');
	        
	        if (remainingSeconds <= 60) {
	            badgeElement.className = 'countdown-timer danger';
	        } else if (remainingSeconds <= 300) {
	            badgeElement.className = 'countdown-timer warning';
	        } else {
	            badgeElement.className = 'countdown-timer';
	        }
	    }
	    
	    async notifyServerAsync(machineId) {
	        try {
	            const response = await fetch(`/admin/machines/${machineId}/auto-complete`, {
	                method: 'POST',
	                headers: { 'Content-Type': 'application/json' }
	            });
	            
	            if (response.ok) {
	                const data = await response.json();
	                console.log(data.success ? `âœ… æˆåŠŸé€šçŸ¥ä¼ºæœå™¨æ©Ÿå™¨ ${machineId} å®Œæˆ` : `âš ï¸ ä¼ºæœå™¨å›æ‡‰å¤±æ•—`);
	            }
	        } catch (error) {
	            console.error(`âŒ ç„¡æ³•é€šçŸ¥ä¼ºæœå™¨: ${error.message}`);
	        }
	    }
	    
	    async syncWithServer() {
	        try {
	            const response = await fetch('/admin/machines/status');
	            if (!response.ok) throw new Error(`HTTP ${response.status}`);
	            const machines = await response.json();
	            
	            console.log('ğŸ”„ ä¸»é èˆ‡ä¼ºæœå™¨åŒæ­¥æ©Ÿå™¨ç‹€æ…‹...');
	            
	            machines.forEach(machine => {
	                if (machine.status === 'AVAILABLE') {
	                    // å¦‚æœä¼ºæœå™¨é¡¯ç¤ºå¯ç”¨ï¼Œæ¸…é™¤ localStorage
	                    if (localStorage.getItem(`machine_${machine.machineId}_endTime`)) {
	                        this.clearMachineStorage(machine.machineId);
	                        this.completedMachines.delete(machine.machineId);
	                        console.log(`âœ… æ©Ÿå™¨ ${machine.machineId} å·²åœ¨ä¼ºæœå™¨ç«¯è®Šç‚ºå¯ç”¨ï¼Œæ¸…é™¤ localStorage`);
	                    }
	                }
	            });
	        } catch (error) {
	            console.error('âŒ ä¸»é åŒæ­¥å¤±æ•—:', error);
	        }
	    }
	    
	    showNotification(title, message, type = 'info', duration = 8000) {
	        const notification = document.createElement('div');
	        notification.className = `alert alert-${type} alert-dismissible fade show notification`;
	        notification.innerHTML = `
	            <div class="d-flex align-items-center">
	                <div class="me-3"><i class="fas fa-bell fs-4"></i></div>
	                <div class="flex-grow-1">
	                    <h6 class="mb-1">${title}</h6>
	                    <p class="mb-0">${message}</p>
	                </div>
	                <button type="button" class="btn-close" onclick="this.closest('.notification').remove()"></button>
	            </div>
	        `;
	        
	        document.body.appendChild(notification);
	        setTimeout(() => { if (notification.parentNode) notification.remove(); }, duration);
	    }
	    
	    playNotificationSound() {
	        try {
	            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
	            const oscillator = audioContext.createOscillator();
	            const gainNode = audioContext.createGain();
	            
	            oscillator.connect(gainNode);
	            gainNode.connect(audioContext.destination);
	            oscillator.frequency.value = 880;
	            oscillator.type = 'sine';
	            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
	            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
	            oscillator.start(audioContext.currentTime);
	            oscillator.stop(audioContext.currentTime + 1);
	        } catch (error) {
	            console.log('ğŸ”‡ ç„¡æ³•æ’­æ”¾æç¤ºéŸ³:', error);
	        }
	    }
	}

	// å…¶ä»–å‡½æ•¸ä¿æŒä¸è®Š
	function toggleForm(formId) {
	    var form = document.getElementById(formId);
	    form.style.display = form.style.display === 'block' ? 'none' : 'block';
	}

	setTimeout(function() {
	    var alerts = document.querySelectorAll('.alert:not(.notification)');
	    alerts.forEach(function(alert) {
	        var bsAlert = new bootstrap.Alert(alert);
	        bsAlert.close();
	    });
	}, 5000);

	document.addEventListener('DOMContentLoaded', function() {
	    if (document.querySelector('.countdown-timer')) {
	        window.mainPageCountdown = new MainPageCountdown();
	    }
	});
	</script>

</body>
</html>
