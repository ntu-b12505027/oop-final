<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ç®¡ç†å“¡é¢æ¿ - å®¿èˆæ´—è¡£æ©Ÿç®¡ç†ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .admin-header {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .stats-card {
            transition: transform 0.2s;
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }
        .machine-table {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .status-badge {
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: bold;
        }
        .nav-tabs .nav-link {
            border-radius: 10px 10px 0 0;
            margin-right: 5px;
        }
        .nav-tabs .nav-link.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        /* ğŸ†• å€’æ•¸è¨ˆæ™‚æ¨£å¼ */
        .countdown-timer {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 14px;
            padding: 6px 12px;
            border-radius: 15px;
            display: inline-block;
            min-width: 80px;
            text-align: center;
        }
        
        .countdown-timer.warning {
            animation: pulse 1s infinite;
        }
        
        .countdown-timer.danger {
            animation: blink 0.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        
        .time-expired {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52) !important;
            color: white !important;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            max-width: 400px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- ç®¡ç†å“¡æ¨™é¡Œ -->
        <div class="admin-header text-center">
            <h1 class="mb-0">
                <i class="fas fa-cogs me-3"></i>
                ğŸ”§ ç®¡ç†å“¡æ§åˆ¶é¢æ¿
            </h1>
            <p class="mb-0 mt-2">å®¿èˆæ´—è¡£æ©Ÿç®¡ç†ç³»çµ±</p>
        </div>
        
        <!-- æˆåŠŸ/éŒ¯èª¤è¨Šæ¯ -->
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            <span th:text="${success}">æˆåŠŸè¨Šæ¯</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>
            <span th:text="${error}">éŒ¯èª¤è¨Šæ¯</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        
        <!-- å°èˆªé¸å–® -->
        <ul class="nav nav-tabs mb-4" role="tablist">
            <li class="nav-item">
                <a class="nav-link" th:classappend="${currentView == 'overview'} ? 'active'" 
                   href="/admin?view=overview">
                    <i class="fas fa-chart-pie me-2"></i>ç¸½è¦½
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:classappend="${currentView == 'machines'} ? 'active'" 
                   href="/admin?view=machines">
                    <i class="fas fa-cog me-2"></i>æ©Ÿå°ç®¡ç†
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:classappend="${currentView == 'reservations'} ? 'active'" 
                   href="/admin?view=reservations">
                    <i class="fas fa-calendar-alt me-2"></i>é ç´„ç®¡ç†
                </a>
            </li>
        </ul>
        
        <!-- ç¸½è¦½é é¢ -->
        <div th:if="${currentView == 'overview' or currentView == null}">
            <!-- çµ±è¨ˆå¡ç‰‡ -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card stats-card bg-primary text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-server fa-2x mb-2"></i>
                            <h4 th:text="${totalMachines}">0</h4>
                            <p class="mb-0">ç¸½æ©Ÿå°æ•¸</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card bg-success text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-check-circle fa-2x mb-2"></i>
                            <h4 th:text="${availableCount}">0</h4>
                            <p class="mb-0">å¯ç”¨æ©Ÿå°</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card bg-warning text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-clock fa-2x mb-2"></i>
                            <h4 th:text="${inUseCount}">0</h4>
                            <p class="mb-0">ä½¿ç”¨ä¸­</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card bg-danger text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                            <h4 th:text="${outOfOrderCount}">0</h4>
                            <p class="mb-0">æ•…éšœæ©Ÿå°</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å¿«é€Ÿæ“ä½œ -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-bolt me-2"></i>å¿«é€Ÿæ“ä½œ
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2 d-md-flex">
                                <a href="/admin?view=machines" class="btn btn-primary">
                                    <i class="fas fa-cog me-2"></i>ç®¡ç†æ©Ÿå°
                                </a>
                                <a href="/admin?view=reservations" class="btn btn-info">
                                    <i class="fas fa-calendar me-2"></i>æŸ¥çœ‹é ç´„
                                </a>
                                <form action="/admin/reset-all" method="post" style="display: inline;">
                                    <button type="submit" class="btn btn-warning" 
                                            onclick="return confirm('âš ï¸ ç¢ºå®šè¦é‡ç½®æ‰€æœ‰ä½¿ç”¨ä¸­çš„æ©Ÿå°å—ï¼Ÿ')">
                                        <i class="fas fa-refresh me-2"></i>é‡ç½®æ‰€æœ‰æ©Ÿå°
                                    </button>
                                </form>
                                <a href="/" class="btn btn-outline-secondary">
                                    <i class="fas fa-home me-2"></i>å›åˆ°ä¸»é 
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ©Ÿå°ç®¡ç†é é¢ -->
        <div th:if="${currentView == 'machines'}">
            <div class="machine-table">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-cog me-2"></i>æ©Ÿå°ç‹€æ…‹ç®¡ç†
                        <small class="ms-3">â±ï¸ å³æ™‚å€’æ•¸è¨ˆæ™‚</small>
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>æ©Ÿå°ID</th>
                                    <th>æ©Ÿå°åç¨±</th>
                                    <th>é¡å‹</th>
                                    <th>æ¨“å±¤</th>
                                    <th>ç›®å‰ç‹€æ…‹</th>
                                    <th>ä½¿ç”¨è€…</th>
                                    <th>â° å‰©é¤˜æ™‚é–“</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="machine : ${machines}">
                                    <td th:text="${machine.machineId}" class="fw-bold">#1</td>
                                    <td>
                                        <i th:class="${machine.type.name() == 'WASHING'} ? 'fas fa-tshirt text-primary' : 'fas fa-wind text-warning'"></i>
                                        <span th:text="${machine.name}" class="ms-2">æ©Ÿå°åç¨±</span>
                                    </td>
                                    <td>
                                        <span th:if="${machine.type.name() == 'WASHING'}" class="badge bg-info">æ´—è¡£æ©Ÿ</span>
                                        <span th:if="${machine.type.name() == 'DRYING'}" class="badge bg-warning">çƒ˜è¡£æ©Ÿ</span>
                                    </td>
                                    <td th:text="${machine.floor} + 'æ¨“'" class="text-center">1æ¨“</td>
                                    <td>
                                        <span th:if="${machine.status.name() == 'AVAILABLE'}" class="status-badge bg-success text-white">å¯ç”¨</span>
                                        <span th:if="${machine.status.name() == 'IN_USE'}" class="status-badge bg-warning text-dark">ä½¿ç”¨ä¸­</span>
                                        <span th:if="${machine.status.name() == 'OUT_OF_ORDER'}" class="status-badge bg-danger text-white">æ•…éšœ</span>
                                    </td>
                                    <td th:text="${machine.currentUserRoom != null ? machine.currentUserRoom : '-'}" class="text-center">-</td>
                                    <!-- ğŸ†• ä¿®æ”¹å‰©é¤˜æ™‚é–“é¡¯ç¤ºç‚ºå€’æ•¸è¨ˆæ™‚ -->
                                    <td class="text-center">
                                        <span th:if="${machine.status.name() == 'IN_USE' and machine.remainingMinutes != null and machine.remainingMinutes > 0}" 
                                              th:data-machine-id="${machine.machineId}"
                                              th:data-remaining="${machine.remainingMinutes}"
                                              th:data-user="${machine.currentUserRoom}"
                                              class="countdown-timer badge bg-primary">
                                            <i class="fas fa-clock me-1"></i>
                                            <span class="time-display" th:text="${machine.remainingMinutes} + 'åˆ†'"></span>
                                        </span>
                                        <span th:unless="${machine.status.name() == 'IN_USE' and machine.remainingMinutes != null and machine.remainingMinutes > 0}" 
                                              class="text-muted">-</span>
                                    </td>
                                    <td>
                                        <a th:href="@{'/admin/machines/' + ${machine.machineId} + '/edit'}" 
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-edit"></i> ç·¨è¼¯
                                        </a>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- é ç´„ç®¡ç†é é¢ -->
        <div th:if="${currentView == 'reservations'}">
            <div class="machine-table">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>é ç´„è¨˜éŒ„ç®¡ç†
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>é ç´„ID</th>
                                    <th>æ©Ÿå°ID</th>
                                    <th>ä½¿ç”¨è€…ID</th>
                                    <th>é–‹å§‹æ™‚é–“</th>
                                    <th>çµæŸæ™‚é–“</th>
                                    <th>é ç´„æ™‚é–“</th>
                                    <th>ç‹€æ…‹</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="reservation : ${reservations}">
                                    <td th:text="${reservation.reservationId}" class="fw-bold">#1</td>
                                    <td th:text="${reservation.machineId}">1</td>
                                    <td th:text="${reservation.userId}">1</td>
                                    <td th:text="${#temporals.format(reservation.startTime, 'yyyy-MM-dd HH:mm')}">æ™‚é–“</td>
                                    <td th:text="${#temporals.format(reservation.endTime, 'yyyy-MM-dd HH:mm')}">æ™‚é–“</td>
                                    <td th:text="${#temporals.format(reservation.bookingTime, 'yyyy-MM-dd HH:mm')}">æ™‚é–“</td>
                                    <td>
                                        <span th:switch="${reservation.status.name()}">
                                            <span th:case="'UPCOMING'" class="badge bg-primary">å³å°‡é–‹å§‹</span>
                                            <span th:case="'IN_PROGRESS'" class="badge bg-warning">é€²è¡Œä¸­</span>
                                            <span th:case="'COMPLETED'" class="badge bg-success">å·²å®Œæˆ</span>
                                            <span th:case="'CANCELED'" class="badge bg-danger">å·²å–æ¶ˆ</span>
                                        </span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- ğŸ†• å€’æ•¸è¨ˆæ™‚åŠŸèƒ½ JavaScript -->
	<script>
	// å€’æ•¸è¨ˆæ™‚ç®¡ç†å™¨ï¼ˆlocalStorage ç‰ˆæœ¬ï¼‰
	class CountdownManager {
	    constructor() {
	        this.timers = new Map();
	        this.completedMachines = new Set();
	        this.soundEnabled = true;
	        this.init();
	    }
	    
	    init() {
	        console.log('ğŸš€ ç®¡ç†å“¡å€’æ•¸è¨ˆæ™‚ç³»çµ±å•Ÿå‹•...');
	        
	        // æ¸…ç†éæœŸçš„ localStorage è³‡æ–™
	        this.cleanExpiredStorage();
	        
	        // åˆå§‹åŒ–æ‰€æœ‰å€’æ•¸è¨ˆæ™‚å™¨
	        document.querySelectorAll('.countdown-timer').forEach(timer => {
	            const machineId = timer.dataset.machineId;
	            const remainingMinutes = parseInt(timer.dataset.remaining);
	            const userRoom = timer.dataset.user;
	            
	            // ğŸ†• å„ªå…ˆå¾ localStorage æ¢å¾©å€’æ•¸è¨ˆæ™‚
	            const savedEndTime = localStorage.getItem(`machine_${machineId}_endTime`);
	            const savedUserRoom = localStorage.getItem(`machine_${machineId}_userRoom`);
	            
	            if (savedEndTime && savedUserRoom) {
	                const now = Date.now();
	                const remainingSeconds = Math.max(0, Math.floor((parseInt(savedEndTime) - now) / 1000));
	                
	                if (remainingSeconds > 0) {
	                    console.log(`ğŸ”„ ç®¡ç†å“¡é é¢å¾ localStorage æ¢å¾©æ©Ÿå™¨ ${machineId} å€’æ•¸è¨ˆæ™‚: ${remainingSeconds} ç§’`);
	                    this.startCountdown(machineId, remainingSeconds, savedUserRoom);
	                    return;
	                } else {
	                    // æ™‚é–“å·²éï¼Œæ¸…é™¤ localStorage
	                    this.clearMachineStorage(machineId);
	                }
	            }
	            
	            // æ²’æœ‰å„²å­˜çš„æ™‚é–“ï¼Œä½¿ç”¨ä¼ºæœå™¨æ™‚é–“
	            if (remainingMinutes > 0 && !this.completedMachines.has(machineId)) {
	                console.log(`â° ç®¡ç†å“¡é é¢å•Ÿå‹•æ©Ÿå™¨ ${machineId} å€’æ•¸è¨ˆæ™‚: ${remainingMinutes} åˆ†é˜ (æˆ¿é–“ ${userRoom})`);
	                this.startCountdown(machineId, remainingMinutes * 60, userRoom);
	            }
	        });
	        
	        // æ¯åˆ†é˜èˆ‡ä¼ºæœå™¨åŒæ­¥ä¸€æ¬¡
	        setInterval(() => this.syncWithServer(), 60000);
	        
	        console.log('âœ… ç®¡ç†å“¡å€’æ•¸è¨ˆæ™‚ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
	    }
	    
	    startCountdown(machineId, remainingSeconds, userRoom) {
	        // æª¢æŸ¥æ˜¯å¦å·²å®Œæˆ
	        if (this.completedMachines.has(machineId)) {
	            console.log(`âš ï¸ æ©Ÿå™¨ ${machineId} å·²å®Œæˆï¼Œä¸å•Ÿå‹•æ–°çš„è¨ˆæ™‚å™¨`);
	            return;
	        }
	        
	        // ğŸ†• è¨ˆç®—ä¸¦å„²å­˜çœŸå¯¦çš„çµæŸæ™‚é–“åˆ° localStorage
	        const endTime = Date.now() + (remainingSeconds * 1000);
	        localStorage.setItem(`machine_${machineId}_endTime`, endTime.toString());
	        localStorage.setItem(`machine_${machineId}_userRoom`, userRoom);
	        console.log(`ğŸ’¾ ç®¡ç†å“¡é é¢å„²å­˜æ©Ÿå™¨ ${machineId} çµæŸæ™‚é–“åˆ° localStorage: ${new Date(endTime)}`);
	        
	        // æ¸…é™¤èˆŠçš„è¨ˆæ™‚å™¨
	        if (this.timers.has(machineId)) {
	            clearInterval(this.timers.get(machineId));
	            this.timers.delete(machineId);
	            console.log(`ğŸ”„ æ¸…é™¤æ©Ÿå™¨ ${machineId} çš„èˆŠè¨ˆæ™‚å™¨`);
	        }
	        
	        const timerElement = document.querySelector(`[data-machine-id="${machineId}"] .time-display`);
	        const badgeElement = document.querySelector(`[data-machine-id="${machineId}"]`);
	        
	        if (!timerElement || !badgeElement) {
	            console.error(`âŒ æ‰¾ä¸åˆ°æ©Ÿå™¨ ${machineId} çš„è¨ˆæ™‚å™¨å…ƒç´ `);
	            return;
	        }
	        
	        const timer = setInterval(() => {
	            // å†æ¬¡æª¢æŸ¥æ˜¯å¦å·²å®Œæˆ
	            if (this.completedMachines.has(machineId)) {
	                console.log(`ğŸ›‘ æ©Ÿå™¨ ${machineId} å·²æ¨™è¨˜ç‚ºå®Œæˆï¼Œåœæ­¢è¨ˆæ™‚å™¨`);
	                clearInterval(timer);
	                this.timers.delete(machineId);
	                return;
	            }
	            
	            // ğŸ†• åŸºæ–¼ localStorage ä¸­çš„çµæŸæ™‚é–“è¨ˆç®—çœŸå¯¦å‰©é¤˜æ™‚é–“
	            const savedEndTime = localStorage.getItem(`machine_${machineId}_endTime`);
	            if (!savedEndTime) {
	                console.log(`âš ï¸ æ©Ÿå™¨ ${machineId} çš„ localStorage è³‡æ–™éºå¤±ï¼Œåœæ­¢è¨ˆæ™‚å™¨`);
	                clearInterval(timer);
	                this.timers.delete(machineId);
	                return;
	            }
	            
	            const now = Date.now();
	            const realRemainingSeconds = Math.max(0, Math.floor((parseInt(savedEndTime) - now) / 1000));
	            
	            if (realRemainingSeconds <= 0) {
	                // ç«‹å³æ¨™è¨˜ç‚ºå®Œæˆ
	                this.completedMachines.add(machineId);
	                
	                // åœæ­¢è¨ˆæ™‚å™¨
	                clearInterval(timer);
	                this.timers.delete(machineId);
	                
	                console.log(`ğŸ¯ ç®¡ç†å“¡é é¢æ©Ÿå™¨ ${machineId} æ™‚é–“åˆ°ï¼ç«‹å³åœæ­¢è¨ˆæ™‚å™¨`);
	                this.onTimeExpired(machineId, userRoom);
	                return;
	            }
	            
	            // æ›´æ–°é¡¯ç¤º
	            const minutes = Math.floor(realRemainingSeconds / 60);
	            const seconds = realRemainingSeconds % 60;
	            
	            let display;
	            if (minutes > 0) {
	                display = `${minutes}åˆ†${seconds.toString().padStart(2, '0')}ç§’`;
	            } else {
	                display = `${seconds}ç§’`;
	            }
	            
	            timerElement.innerHTML = `<i class="fas fa-clock me-1"></i>${display}`;
	            
	            // æ ¹æ“šå‰©é¤˜æ™‚é–“èª¿æ•´æ¨£å¼
	            this.updateTimerStyle(badgeElement, realRemainingSeconds);
	            
	        }, 1000);
	        
	        this.timers.set(machineId, timer);
	    }
	    
	    updateTimerStyle(badgeElement, remainingSeconds) {
	        // ç§»é™¤æ‰€æœ‰æ¨£å¼é¡
	        badgeElement.className = badgeElement.className.replace(/warning|danger/g, '');
	        
	        if (remainingSeconds <= 60) {
	            // æœ€å¾Œ1åˆ†é˜ï¼šç´…è‰²é–ƒçˆ
	            badgeElement.className = 'countdown-timer badge bg-danger danger';
	        } else if (remainingSeconds <= 300) {
	            // æœ€å¾Œ5åˆ†é˜ï¼šé»ƒè‰²è„ˆå‹•
	            badgeElement.className = 'countdown-timer badge bg-warning text-dark warning';
	        } else {
	            // æ­£å¸¸ç‹€æ…‹ï¼šè—è‰²
	            badgeElement.className = 'countdown-timer badge bg-primary';
	        }
	    }
	    
	    async onTimeExpired(machineId, userRoom) {
	        console.log(`ğŸ‰ ç®¡ç†å“¡é é¢æ©Ÿå™¨ ${machineId} æ™‚é–“åˆ°ï¼æˆ¿é–“ ${userRoom}`);
	        
	        // ç¢ºä¿è¨ˆæ™‚å™¨å·²åœæ­¢ä¸”æ¨™è¨˜ç‚ºå®Œæˆ
	        if (this.timers.has(machineId)) {
	            clearInterval(this.timers.get(machineId));
	            this.timers.delete(machineId);
	        }
	        this.completedMachines.add(machineId);
	        
	        // ğŸ†• æ¸…é™¤ localStorage è³‡æ–™
	        this.clearMachineStorage(machineId);
	        
	        const timerElement = document.querySelector(`[data-machine-id="${machineId}"]`);
	        
	        if (!timerElement) {
	            console.error(`âŒ æ‰¾ä¸åˆ°æ©Ÿå™¨ ${machineId} çš„è¨ˆæ™‚å™¨å…ƒç´ `);
	            return;
	        }
	        
	        // ç«‹å³æ›´æ–°é¡¯ç¤º
	        timerElement.innerHTML = '<i class="fas fa-check me-1"></i>å®Œæˆ';
	        timerElement.className = 'countdown-timer badge time-expired';
	        
	        // é¡¯ç¤ºé€šçŸ¥
	        this.showNotification(
	            `ğŸ‰ æ©Ÿå™¨ #${machineId} ä½¿ç”¨å®Œç•¢ï¼`,
	            `æˆ¿é–“ ${userRoom} çš„æ´—è¡£å·²å®Œæˆï¼Œæ©Ÿå™¨ç¾åœ¨å¯ç”¨`,
	            'success',
	            8000
	        );
	        
	        // æ’­æ”¾æç¤ºéŸ³ï¼ˆå¦‚æœæ”¯æ´ï¼‰
	        this.playNotificationSound();
	        
	        try {
	            // è‡ªå‹•æ›´æ–°æ©Ÿå™¨ç‹€æ…‹ç‚ºå¯ç”¨
	            const response = await fetch(`/admin/machines/${machineId}/auto-complete`, {
	                method: 'POST',
	                headers: {
	                    'Content-Type': 'application/json',
	                }
	            });
	            
	            const data = await response.json();
	            
	            if (data.success) {
	                console.log(`âœ… ç®¡ç†å“¡é é¢æ©Ÿå™¨ ${machineId} è‡ªå‹•è¨­ç‚ºå¯ç”¨`);
	                
	                // æ›´æ–°é é¢é¡¯ç¤º
	                setTimeout(() => {
	                    this.updateMachineRow(machineId);
	                }, 2000);
	            } else {
	                console.error('âŒ è‡ªå‹•æ›´æ–°å¤±æ•—:', data.message);
	                this.showNotification('âš ï¸ è‡ªå‹•æ›´æ–°å¤±æ•—', data.message, 'warning');
	            }
	        } catch (error) {
	            console.error('âŒ è‡ªå‹•æ›´æ–°éŒ¯èª¤:', error);
	            this.showNotification('âš ï¸ é€£ç·šéŒ¯èª¤', 'ç„¡æ³•è‡ªå‹•æ›´æ–°æ©Ÿå™¨ç‹€æ…‹', 'danger');
	        }
	    }
	    
	    updateMachineRow(machineId) {
	        const row = document.querySelector(`[data-machine-id="${machineId}"]`).closest('tr');
	        if (row) {
	            const statusCell = row.cells[4]; // ç‹€æ…‹æ¬„
	            const userCell = row.cells[5];   // ä½¿ç”¨è€…æ¬„
	            const timeCell = row.cells[6];   // æ™‚é–“æ¬„
	            
	            statusCell.innerHTML = '<span class="status-badge bg-success text-white">å¯ç”¨</span>';
	            userCell.textContent = '-';
	            timeCell.innerHTML = '<span class="text-muted">-</span>';
	        }
	    }
	    
	    async syncWithServer() {
	        try {
	            const response = await fetch('/admin/machines/status');
	            if (!response.ok) throw new Error(`HTTP ${response.status}`);
	            const machines = await response.json();
	            
	            console.log('ğŸ”„ ç®¡ç†å“¡é é¢èˆ‡ä¼ºæœå™¨åŒæ­¥æ©Ÿå™¨ç‹€æ…‹...');
	            
	            machines.forEach(machine => {
	                if (machine.status === 'AVAILABLE') {
	                    // å¦‚æœä¼ºæœå™¨é¡¯ç¤ºå¯ç”¨ï¼Œæ¸…é™¤ localStorage
	                    if (localStorage.getItem(`machine_${machine.machineId}_endTime`)) {
	                        this.clearMachineStorage(machine.machineId);
	                        this.completedMachines.delete(machine.machineId);
	                        console.log(`âœ… æ©Ÿå™¨ ${machine.machineId} å·²åœ¨ä¼ºæœå™¨ç«¯è®Šç‚ºå¯ç”¨ï¼Œæ¸…é™¤ localStorage`);
	                    }
	                } else if (machine.status === 'IN_USE' && machine.remainingMinutes > 0) {
	                    // æª¢æŸ¥æ˜¯å¦éœ€è¦é‡æ–°åŒæ­¥å€’æ•¸è¨ˆæ™‚
	                    const currentTimer = this.timers.get(machine.machineId);
	                    if (!currentTimer && !this.completedMachines.has(machine.machineId)) {
	                        console.log(`ğŸ”„ ç®¡ç†å“¡é é¢é‡æ–°åŒæ­¥æ©Ÿå™¨ ${machine.machineId} å€’æ•¸è¨ˆæ™‚`);
	                        this.startCountdown(machine.machineId, machine.remainingMinutes * 60, machine.currentUserRoom);
	                    }
	                }
	            });
	        } catch (error) {
	            console.error('âŒ ç®¡ç†å“¡é é¢åŒæ­¥å¤±æ•—:', error);
	        }
	    }
	    
	    // ğŸ†• æ¸…é™¤æ©Ÿå™¨çš„ localStorage è³‡æ–™
	    clearMachineStorage(machineId) {
	        localStorage.removeItem(`machine_${machineId}_endTime`);
	        localStorage.removeItem(`machine_${machineId}_userRoom`);
	        console.log(`ğŸ—‘ï¸ æ¸…é™¤æ©Ÿå™¨ ${machineId} çš„ localStorage è³‡æ–™`);
	    }
	    
	    // ğŸ†• æ¸…ç†éæœŸçš„ localStorage è³‡æ–™
	    cleanExpiredStorage() {
	        const now = Date.now();
	        const keysToRemove = [];
	        
	        for (let i = 0; i < localStorage.length; i++) {
	            const key = localStorage.key(i);
	            if (key && key.startsWith('machine_') && key.endsWith('_endTime')) {
	                const endTime = parseInt(localStorage.getItem(key));
	                if (endTime && endTime < now) {
	                    // æ‰¾åˆ°å°æ‡‰çš„æ©Ÿå™¨ID
	                    const machineId = key.replace('machine_', '').replace('_endTime', '');
	                    keysToRemove.push(machineId);
	                }
	            }
	        }
	        
	        // æ¸…é™¤éæœŸçš„è³‡æ–™
	        keysToRemove.forEach(machineId => {
	            this.clearMachineStorage(machineId);
	            console.log(`ğŸ§¹ æ¸…é™¤éæœŸçš„æ©Ÿå™¨ ${machineId} localStorage è³‡æ–™`);
	        });
	    }
	    
	    showNotification(title, message, type = 'info', duration = 5000) {
	        const notification = document.createElement('div');
	        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
	        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
	        notification.innerHTML = `
	            <strong>${title}</strong><br>
	            ${message}
	            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
	        `;
	        
	        document.body.appendChild(notification);
	        
	        // è‡ªå‹•ç§»é™¤
	        setTimeout(() => {
	            if (notification.parentNode) {
	                notification.remove();
	            }
	        }, duration);
	    }
	    
	    playNotificationSound() {
	        try {
	            // å‰µå»ºç°¡å–®çš„æç¤ºéŸ³
	            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
	            const oscillator = audioContext.createOscillator();
	            const gainNode = audioContext.createGain();
	            
	            oscillator.connect(gainNode);
	            gainNode.connect(audioContext.destination);
	            
	            oscillator.frequency.value = 800;
	            oscillator.type = 'sine';
	            
	            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
	            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
	            
	            oscillator.start(audioContext.currentTime);
	            oscillator.stop(audioContext.currentTime + 0.5);
	        } catch (error) {
	            console.log('ğŸ”‡ ç„¡æ³•æ’­æ”¾æç¤ºéŸ³:', error);
	        }
	    }
	}

	// é é¢è¼‰å…¥å¾Œå•Ÿå‹•å€’æ•¸è¨ˆæ™‚ç³»çµ±
	document.addEventListener('DOMContentLoaded', function() {
	    // åªåœ¨æ©Ÿå°ç®¡ç†é é¢å•Ÿå‹•å€’æ•¸è¨ˆæ™‚
	    if (document.querySelector('.countdown-timer')) {
	        window.countdownManager = new CountdownManager();
	    }
	});
	</script>

</body>
</html>
